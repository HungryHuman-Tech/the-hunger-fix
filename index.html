<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THE HUNGER FIX</title>
    <style>
        body, html { 
            margin: 0; padding: 0; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            background-color: #ffffff; color: #000000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            overflow: hidden; 
        }
        #app-container { text-align: center; width: 95%; max-width: 400px; min-width: 320px; transition: all 0.4s ease; }
        .fade-in { opacity: 1; transform: translateY(0); transition: 0.4s; }
        .fade-out { opacity: 0; transform: translateY(-20px); transition: 0.4s; }
        
        h1 { 
            font-weight: 800; margin-bottom: 1.5rem; font-size: 1.6rem; 
            letter-spacing: 0.5px; text-transform: uppercase; 
            white-space: nowrap; overflow: hidden; 
        }
        
        .input-wrapper { position: relative; width: 100%; }
        input { width: 100%; padding: 18px; border: 1px solid black; margin-bottom: 1rem; box-sizing: border-box; font-size: 1rem; text-align: center; outline: none; border-radius: 0; }
        #suggestions { position: absolute; top: 56px; left: 0; width: 100%; background: white; border: 1px solid black; border-top: none; z-index: 100; max-height: 200px; overflow-y: auto; display: none; }
        .suggestion-item { padding: 14px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.85rem; text-align: left; color: black; }
        .suggestion-item:hover { background-color: #f9f9f9; }
        
        button { background: black; color: white; border: 1px solid black; padding: 18px; width: 100%; cursor: pointer; font-size: 1rem; margin-bottom: 12px; transition: 0.2s; border-radius: 0; }
        .secondary-btn { background: white; color: black; }
        .surprise-btn { background: #FF3B30; border-color: #FF3B30; font-weight: bold; margin-top: 10px; }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }
        .pulse-ready { animation: pulse 1.5s infinite; border-width: 2px; }

        .dist-label { font-size: 0.7rem; font-weight: bold; margin-bottom: 10px; color: #666; text-transform: uppercase; }
        .dist-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .dist-btn { padding: 12px 5px; border: 1px solid black; background: white; cursor: pointer; font-size: 0.75rem; color: black; font-weight: bold; }
        .dist-btn.active { background: black; color: white; }

        .spot-card { border: 2px solid black; padding: 35px 25px; margin-top: 10px; text-align: left; position: relative; background: #fff; }
        .best-badge { position: absolute; top: -12px; left: 20px; background: #FF3B30; color: white; padding: 4px 12px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .rating-tag { font-size: 0.9rem; color: #f1c40f; font-weight: bold; margin-bottom: 5px; display: block; }
        .summary-text { font-size: 0.85rem; color: #444; line-height: 1.4; margin: 10px 0; font-style: italic; }
        .action-btn { display: block; text-align: center; padding: 16px; margin-top: 15px; border: 1px solid black; text-decoration: none; color: white; background: black; font-weight: bold; font-size: 0.9rem; }
        
        .back-link { display: block; margin-top: 25px; text-decoration: underline; cursor: pointer; font-size: 0.8rem; color: #666; border: none; background: none; width: 100%; }
        
        .smiley-loader { font-size: 2.5rem; margin-bottom: 15px; display: block; height: 50px; }
        .joke-container { font-style: italic; color: #777; padding: 0 20px; line-height: 1.5; font-size: 1rem; min-height: 80px; }
        .loading-header { font-weight: bold; color: #000; margin-bottom: 10px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;}
    </style>
</head>
<body>

    <div id="app-container" class="fade-in">
        <div id="screen-content">
            <h1>THE HUNGER FIX</h1>
            <div class="input-wrapper">
                <input type="text" id="cityInput" placeholder="Where are you? (City, State)" autocomplete="off" oninput="debounceSearch()">
                <div id="suggestions"></div>
            </div>
            <button id="nextBtn" onclick="handleNext()">Next</button>
            <button class="secondary-btn" onclick="locateMe()">Locate Me</button>
        </div>
    </div>

    <script>
        const GOOGLE_API_KEY = "AIzaSyBkYWkdgAQ0hB_hlFmTLcJxm0dvDDO7JVA";

        const container = document.getElementById('app-container');
        const screen = document.getElementById('screen-content');
        let lat = "", lon = "";
        let selectedVibe = "";
        let userLimitDist = 5000; 
        let blacklist = new Set();
        
        const distanceTiers = [5000, 15000, 30000, 80000];
        let activeTierIndex = 0;
        let activeSearchType = "";

        const smileys = ["ü§î", "üßê", "üòã", "ü§§", "üçï", "üåÆ", "üç£", "ü•ó"];
        const errorSmileys = ["üíÄ", "ü™¶", "üèúÔ∏è", "ü´†", "üìâ", "üíî"];
        
        const jokes = {
            'a date': [
                "Finding a venue where 'split the bill' won't ruin the second date...",
                "Hunting for a place where the background music isn't just EDM remixes.",
                "Finding a spot where you can actually pronounce the menu items.",
                "Looking for a place where the lighting makes everyone look like a 10."
            ],
            'family': [
                "Finding a floor durable enough for a juice box explosion...",
                "Locating a spot that considers 'screaming' a part of the ambiance.",
                "Searching for a restaurant with a 5-star rating and 5-star high chairs.",
                "Scanning for menus that double as coloring books."
            ],
            'yourself': [
                "Finding a spot where your phone is the only company you need...",
                "Searching for a place that won't ask 'just one?' with a look of pity.",
                "Picking a spot where you can eat like nobody is watching (because they aren't).",
                "Looking for a place where the Wi-Fi is faster than the service."
            ],
            'general': [
                "Consulting the burger gods for the perfect patty...",
                "Calculating how far I‚Äôd walk for a taco. (Hint: it‚Äôs very far).",
                "Analyzing menus for hidden gems and overpriced toast.",
                "Bargaining with the algorithm for shorter wait times.",
                "Making sure the chef is having a good day.",
                "Polishing the silverware in the cloud...",
                "Downloading extra flavor, please wait."
            ],
            'error': [
                "Our satellite hit a pigeon. Please try again.",
                "The chef quit to become a DJ. Total disaster.",
                "Your internet is acting hangry. Check your connection.",
                "Google told us to go outside and touch grass. We refused.",
                "The algorithm is on a juice cleanse and won't look at food."
            ]
        };

        const cuisineMapping = {
            'Mexican': 'mexican_restaurant', 'Indian': 'indian_restaurant',
            'Italian': 'italian_restaurant', 'Asian': 'asian_restaurant',
            'French': 'french_restaurant', 'Mediterranean': 'mediterranean_restaurant',
            'Burgers': 'hamburger_restaurant', 'Sushi': 'sushi_restaurant'
        };

        document.addEventListener('click', function(event) {
            const list = document.getElementById('suggestions');
            const input = document.getElementById('cityInput');
            if (list && input && !input.contains(event.target) && !list.contains(event.target)) {
                list.style.display = 'none';
            }
        });

        function handleNext() { 
            if (!lat) return alert("Select a city first!"); 
            showWhoIsGoing(); 
        }

        function showWhoIsGoing() { 
            transition(() => { 
                screen.innerHTML = `
                    <h1>Who's going?</h1>
                    <button onclick="showCuisineFilters('a date')">A Date</button>
                    <button onclick="showCuisineFilters('yourself')">Just Me</button>
                    <button onclick="showCuisineFilters('family')">With Family</button>
                    <button class="back-link" onclick="location.reload()">‚¨Ö Wait, change my location</button>
                `; 
            }); 
        }

        function showCuisineFilters(vibe) {
            selectedVibe = vibe || selectedVibe;
            transition(() => {
                screen.innerHTML = `
                    <h1>The Vibe</h1>
                    <div class="dist-label">Starting Radius</div>
                    <div class="dist-toggle">
                        <button class="dist-btn ${userLimitDist === 5000 ? 'active' : ''}" onclick="userLimitDist=5000; showCuisineFilters()">5 km</button>
                        <button class="dist-btn ${userLimitDist === 15000 ? 'active' : ''}" onclick="userLimitDist=15000; showCuisineFilters()">15 km</button>
                        <button class="dist-btn ${userLimitDist === 30000 ? 'active' : ''}" onclick="userLimitDist=30000; showCuisineFilters()">30 km</button>
                    </div>
                    ${Object.keys(cuisineMapping).map(opt => `<button onclick="startSearch('${opt}')">${opt}</button>`).join("")}
                    <button class="surprise-btn" onclick="surpriseMe()">‚ú® Surprise Me</button>
                    <button class="back-link" onclick="showWhoIsGoing()">Back</button>
                `;
            });
        }

        function surpriseMe() {
            const keys = Object.keys(cuisineMapping);
            startSearch(keys[Math.floor(Math.random() * keys.length)]);
        }

        function startSearch(type) {
            activeSearchType = type;
            activeTierIndex = distanceTiers.indexOf(userLimitDist);
            runTieredSearch();
        }

        async function runTieredSearch() {
            const currentDist = distanceTiers[activeTierIndex];
            const pool = jokes[selectedVibe] ? [...jokes[selectedVibe], ...jokes['general']] : jokes['general'];
            const randomJoke = pool[Math.floor(Math.random() * pool.length)];

            let smileyIdx = 0;
            screen.innerHTML = `
                <div class="smiley-loader" id="loader-icon">ü§î</div>
                <div class="loading-header">Searching in ${currentDist/1000}km...</div>
                <div class="joke-container">"${randomJoke}"</div>
            `;
            
            const loaderInterval = setInterval(() => {
                smileyIdx = (smileyIdx + 1) % smileys.length;
                const icon = document.getElementById('loader-icon');
                if(icon) icon.innerText = smileys[smileyIdx];
            }, 300);

            const startTime = Date.now();
            let result = null;
            let hasError = false;

            try {
                const url = 'https://places.googleapis.com/v1/places:searchNearby';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Goog-Api-Key': GOOGLE_API_KEY,
                        'X-Goog-FieldMask': 'places.displayName,places.rating,places.userRatingCount,places.googleMapsUri,places.id,places.editorialSummary'
                    },
                    body: JSON.stringify({
                        includedTypes: [cuisineMapping[activeSearchType]],
                        maxResultCount: 20,
                        locationRestriction: { circle: { center: { latitude: lat, longitude: lon }, radius: currentDist } }
                    })
                });

                if (!response.ok) throw new Error('API_FAIL');
                
                const data = await response.json();
                const available = (data.places || []).filter(place => !blacklist.has(place.id));
                if (available.length > 0) result = available[Math.floor(Math.random() * available.length)];
            } catch (e) { 
                console.error(e);
                hasError = true;
            }

            const elapsed = Date.now() - startTime;
            const remaining = Math.max(2000 - elapsed, 0);

            setTimeout(() => {
                clearInterval(loaderInterval);
                if (hasError) {
                    showError();
                } else if (result) {
                    showVerdict(result);
                } else if (activeTierIndex < distanceTiers.length - 1) {
                    activeTierIndex++;
                    runTieredSearch();
                } else {
                    screen.innerHTML = `<h1>Empty Plate</h1><p>Nothing found within 80km.</p><button onclick="blacklist.clear(); showCuisineFilters();">Reset Search</button>`;
                }
            }, remaining);
        }

        function showVerdict(place) {
            transition(() => {
                screen.innerHTML = `
                    <h1>THE FIX</h1>
                    <div class="spot-card">
                        <div class="best-badge">${activeSearchType}</div>
                        <span class="rating-tag">‚≠ê ${place.rating || 'N/A'}</span>
                        <h2 style="margin: 0 0 5px 0;">${place.displayName.text}</h2>
                        <p class="summary-text">"${place.editorialSummary?.text || 'A highly-rated local favorite.'}"</p>
                        <a href="${place.googleMapsUri}" target="_blank" class="action-btn">üìç Navigate There</a>
                    </div>
                    <button style="background:#f0f0f0; color:black; border:none; margin-top:15px; font-size:0.85rem; padding:12px;" onclick="blacklist.add('${place.id}'); runTieredSearch();">Show Me Another</button>
                    <button class="back-link" onclick="showCuisineFilters()">Change Vibe</button>
                `;
            });
        }

        function showError() {
            const errJoke = jokes.error[Math.floor(Math.random() * jokes.error.length)];
            const errSmiley = errorSmileys[Math.floor(Math.random() * errorSmileys.length)];
            transition(() => {
                screen.innerHTML = `
                    <div class="smiley-loader">${errSmiley}</div>
                    <h1>FIX FAILED</h1>
                    <div class="joke-container" style="color:#FF3B30;">"${errJoke}"</div>
                    <button onclick="runTieredSearch()">Try Again</button>
                    <button class="back-link" onclick="location.reload()">Start Over</button>
                `;
            });
        }

        function transition(cb) { container.classList.add('fade-out'); setTimeout(() => { cb(); container.classList.remove('fade-out'); container.classList.add('fade-in'); }, 400); }
        
        function debounceSearch() { 
            clearTimeout(this.timeout); 
            this.timeout = setTimeout(async () => { 
                const val = document.getElementById('cityInput').value; 
                if(val.length < 3) {
                    document.getElementById('suggestions').style.display = 'none';
                    return;
                }
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}`); 
                const data = await res.json(); 
                const list = document.getElementById('suggestions'); 
                list.innerHTML = ""; 
                
                if (data.length > 0) {
                    list.style.display = 'block'; 
                    data.forEach(item => { 
                        const div = document.createElement('div'); 
                        div.className = 'suggestion-item'; 
                        div.innerText = item.display_name; 
                        div.onclick = (e) => { 
                            e.stopPropagation();
                            document.getElementById('cityInput').value = item.display_name; 
                            lat = parseFloat(item.lat); 
                            lon = parseFloat(item.lon); 
                            list.style.display = 'none'; 
                        }; 
                        list.appendChild(div); 
                    });
                } else {
                    list.style.display = 'none';
                }
            }, 300); 
        }

        async function locateMe() { 
            const input = document.getElementById('cityInput');
            const nextBtn = document.getElementById('nextBtn');
            input.placeholder = "Locating you...";
            input.value = ""; 
            
            navigator.geolocation.getCurrentPosition(async (pos) => { 
                lat = pos.coords.latitude; 
                lon = pos.coords.longitude; 
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                    const data = await res.json();
                    const cityName = data.address.city || data.address.town || data.address.village || "My Location";
                    const stateName = data.address.state || "";
                    input.value = stateName ? `${cityName}, ${stateName}` : cityName;
                    input.placeholder = "Where are you? (City, State)";
                    nextBtn.classList.add('pulse-ready');
                } catch (e) {
                    input.value = "My Location";
                }
            }, (error) => {
                alert("Location access denied.");
                input.placeholder = "Where are you? (City, State)";
            }); 
        }
    </script>
</body>
</html>
