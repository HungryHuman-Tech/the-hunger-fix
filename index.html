<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>THE HUNGER FIX</title>
    <style>
        /* DYNAMIC SCROLLABLE CENTERING */
        body, html { 
            margin: 0; padding: 0; width: 100%;
            background-color: #ffffff; color: #000000; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; justify-content: center; align-items: center;
            min-height: 100dvh; /* Use dynamic viewport height */
            overflow-x: hidden;
            overflow-y: auto; /* Re-enabled scrolling */
            touch-action: manipulation;
        }

        #app-container { 
            text-align: center; width: 90%; max-width: 400px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 40px 0 120px 0; /* Extra bottom padding for History Bar */
            transition: all 0.4s ease; 
        }

        .fade-in { opacity: 1; transform: translateY(0); transition: 0.4s; }
        .fade-out { opacity: 0; transform: translateY(-20px); transition: 0.4s; }
        
        h1 { font-weight: 900; margin-bottom: 2rem; font-size: 1.8rem; letter-spacing: 1px; text-transform: uppercase; width: 100%; }
        
        .input-wrapper { position: relative; width: 100%; }
        input { 
            width: 100%; padding: 20px; border: 2px solid black; 
            margin-bottom: 1.2rem; box-sizing: border-box; 
            font-size: 16px; text-align: center; outline: none; 
            border-radius: 0; -webkit-appearance: none;
        }

        #suggestions { 
            position: absolute; width: 100%; background: white; 
            border: 2px solid black; border-top: none; z-index: 100; 
            max-height: 200px; overflow-y: auto; display: none; 
            margin-top: -1.2rem;
        }

        .suggestion-item { padding: 15px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.85rem; text-align: left; line-height: 1.4; }
        
        button { background: black; color: white; border: 2px solid black; padding: 18px; width: 100%; cursor: pointer; font-size: 1rem; margin-bottom: 12px; transition: 0.2s; border-radius: 0; font-weight: bold; text-transform: uppercase; }
        .secondary-btn { background: white; color: black; }
        .shuffle-btn { background: #FF3B30; border-color: #FF3B30; color: white; margin-top: 10px; }

        /* BLACK FILTER SECTION */
        .filter-section { 
            margin-bottom: 25px; padding: 20px; 
            background: #000000; color: #ffffff; /* Inverted Theme */
            width: 100%; box-sizing: border-box; 
        }
        .dist-label { font-size: 0.75rem; font-weight: 900; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; }
        .dist-toggle { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .dist-btn { padding: 12px 2px; border: 1px solid white; background: transparent; color: white; font-size: 0.7rem; font-weight: bold; cursor: pointer; }
        .dist-btn.active { background: white; color: black; }

        .toggle-container { display: flex; justify-content: space-between; align-items: center; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; }
        input:checked + .slider { background-color: #FF3B30; }
        input:checked + .slider:before { transform: translateX(20px); }

        .spot-card { border: 2px solid black; padding: 35px 20px; text-align: left; position: relative; background: #fff; margin: 10px 0; width: 100%; box-sizing: border-box; }
        .best-badge { position: absolute; top: -12px; left: 20px; background: #FF3B30; color: white; padding: 4px 12px; font-size: 0.7rem; font-weight: bold; }
        .action-btn { display: block; text-align: center; padding: 18px; margin-top: 15px; text-decoration: none; color: white; background: black; font-weight: 900; }
        
        .back-link { display: block; margin-top: 20px; text-decoration: underline; cursor: pointer; font-size: 0.8rem; border: none; background: none; width: 100%; color: black; font-weight: bold; }

        .smiley-flicker { font-size: 4.5rem; margin-bottom: 20px; display: inline-block; }
        .joke-container { font-style: italic; color: #555; padding: 0 20px; font-size: 1.1rem; min-height: 80px; line-height: 1.4; display: flex; align-items: center; justify-content: center; }
        .status-pulse { font-size: 0.75rem; font-weight: 900; color: #FF3B30; letter-spacing: 1.5px; text-transform: uppercase; margin-top: 10px; }

        .history-bar-btn { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-top: 3px solid black; padding: 20px; z-index: 150; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .history-bar-btn span { color: #000 !important; font-weight: 900; letter-spacing: 2px; font-size: 0.85rem; }
        #history-count { background: #000; color: #fff; border-radius: 50%; width: 22px; height: 22px; display: flex; justify-content: center; align-items: center; font-size: 0.7rem; }
        
        #history-panel { position: fixed; bottom: -500px; left: 0; right: 0; height: 400px; background: white; border-top: 3px solid black; transition: bottom 0.4s ease; z-index: 200; padding: 20px; overflow-y: auto; text-align: left; }
        #history-panel.open { bottom: 0; }
        .history-item { padding: 15px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

    <div id="app-container" class="fade-in">
        <div id="screen-content" style="width: 100%;">
            <h1>THE HUNGER FIX</h1>
            <div class="input-wrapper">
                <input type="text" id="cityInput" placeholder="Street, City, State..." oninput="debounceSearch()">
                <div id="suggestions"></div>
            </div>
            <button onclick="handleNext()">Find My Food</button>
            <button class="secondary-btn" onclick="locateMe()">Locate Me</button>
        </div>
    </div>

    <button id="history-btn" class="history-bar-btn" onclick="toggleHistory()" style="display:none;">
        <span>HISTORY</span>
        <div id="history-count">0</div>
    </button>
    
    <div id="history-panel">
        <h3 style="text-transform: uppercase; border-bottom: 2px solid black; padding-bottom: 10px;">Recent 5 Spots</h3>
        <div id="history-list"></div>
        <button class="back-link" onclick="toggleHistory()" style="text-transform: uppercase;">Close</button>
    </div>

    <script>
        const GOOGLE_API_KEY = "YOUR_GOOGLE_API_KEY"; // REPLACE THIS

        const container = document.getElementById('app-container');
        const screen = document.getElementById('screen-content');
        let lat = "", lon = "";
        let userLimitDist = 15000; 
        let openNowOnly = true; 
        let blacklist = new Set();
        let history = []; 
        let flickerInterval;

        const searchEmojis = ["üçï", "üçî", "üåÆ", "üç£", "üç¶", "ü•™", "üç≥", "üçú", "üç©", "üç±"];
        const errorEmojis = ["üíÄ", "ü´†", "üìâ", "‚úñÔ∏è", "üö©"];

        const searchJokes = [
            "Consulting the burger gods...", "Searching for hidden fries...", "Negotiating with delivery drivers...",
            "Bribing the local chefs...", "Scanning the flavor horizon...", "Asking the microwave for advice...",
            "Checking under the couch for snacks...", "Following the scent of garlic...", "Calculating the perfect bite ratio...",
            "Convincing the GPS you're starving...", "Updating the satellite on your cravings...", "Deploying the spice-seeking drones...",
            "Waking up the kitchen staff...", "Scanning for artisanal breadcrumbs...", "Checking if the pizza oven is preheated...",
            "Translating 'I'm hungry' into satellite...", "Measuring the distance to dessert...", "Syncing with the local taco trucks...",
            "Evaluating cheese-to-crust variables...", "Finalizing the flavor profile..."
        ];

        const errorJokes = [
            "Even the rats are hungry here. No spots found.", "Looks like a culinary desert. Try a wider scan.", "The fridge is looking better than these results.",
            "Our satellite is hangry and refusing to work.", "Everything is closed. Maybe a nap instead?", "The chefs have gone on strike. Try again.",
            "GPS lost its appetite. Re-centering...", "Zero flavor detected in this radius.", "The spice must flow... but it isn't flowing here.",
            "Did you enter a ghost town? No results.", "Even the vending machines are empty.", "A culinary void has been detected.",
            "Error: Hunger levels too high for this area.", "The kitchen is dark. The lights are out.", "No food found. Sending thoughts and prayers.",
            "You've reached the edge of the flavor world.", "The delivery drivers are all sleeping.", "Try moving 5 feet to the left? (Just kidding).",
            "This area is strictly for water drinkers only.", "Alert: Tactical starvation imminent."
        ];

        const cuisineMapping = {
            'Comfort': ['hamburger_restaurant', 'steak_house', 'pizza_restaurant'],
            'Spicy': ['mexican_restaurant', 'indian_restaurant', 'thai_restaurant'],
            'Fancy': ['fine_dining_restaurant', 'french_restaurant', 'seafood_restaurant'],
            'Healthy': ['vegan_restaurant', 'vegetarian_restaurant', 'salad_shop'],
            'Quick': ['sandwich_shop', 'cafe', 'bakery'],
            'Late Night': ['diner', 'pizza_restaurant', 'fast_food_restaurant']
        };

        function startFlicker(emojiSet) {
            stopFlicker();
            const el = document.getElementById('flicker-target');
            if(!el) return;
            flickerInterval = setInterval(() => { el.innerText = emojiSet[Math.floor(Math.random() * emojiSet.length)]; }, 400); 
        }

        function stopFlicker() { if (flickerInterval) clearInterval(flickerInterval); }

        function handleNext() { if (!lat) return alert("Please select a location!"); showCuisineSelection(); }

        function showCuisineSelection() {
            transition(() => {
                screen.innerHTML = `
                    <div class="filter-section">
                        <div class="dist-label">Max Distance</div>
                        <div class="dist-toggle">
                            ${[5000, 15000, 25000, 35000].map(d => `<button class="dist-btn ${userLimitDist === d ? 'active' : ''}" onclick="userLimitDist=${d}; showCuisineSelection()">${d/1000}KM</button>`).join('')}
                        </div>
                        <div class="toggle-container">
                            <span class="dist-label">Open Now</span>
                            <label class="switch">
                                <input type="checkbox" ${openNowOnly ? 'checked' : ''} onchange="openNowOnly = this.checked">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <h1>Hungry for?</h1>
                    ${Object.keys(cuisineMapping).map(opt => `<button onclick="startSearch('${opt}')">${opt}</button>`).join("")}
                    <button class="shuffle-btn" onclick="startSearch('Surprise')">üé≤ Surprise Me</button>
                    <button class="back-link" onclick="location.reload()">Reset Address</button>
                `;
            });
        }

        async function startSearch(type, currentTierIdx = null) {
            const tiers = [5000, 15000, 25000, 35000];
            if (currentTierIdx === null) currentTierIdx = tiers.indexOf(userLimitDist);
            const currentDist = tiers[currentTierIdx];
            
            screen.innerHTML = `
                <div><span id="flicker-target" class="smiley-flicker">üçï</span></div>
                <div class="joke-container">"${searchJokes[Math.floor(Math.random() * searchJokes.length)]}"</div>
                <div class="status-pulse">Scanning ${currentDist/1000}KM...</div>
            `;
            startFlicker(searchEmojis);

            await new Promise(r => setTimeout(r, 2200)); 
            let searchType = type === 'Surprise' ? Object.keys(cuisineMapping)[Math.floor(Math.random() * 6)] : type;

            try {
                const response = await fetch('https://places.googleapis.com/v1/places:searchNearby', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Goog-Api-Key': GOOGLE_API_KEY, 'X-Goog-FieldMask': 'places.displayName,places.rating,places.googleMapsUri,places.id,places.currentOpeningHours' },
                    body: JSON.stringify({
                        includedTypes: cuisineMapping[searchType],
                        maxResultCount: 20,
                        locationRestriction: { circle: { center: { latitude: lat, longitude: lon }, radius: currentDist } }
                    })
                });

                const data = await response.json();
                let placeList = (data.places || []).filter(p => !blacklist.has(p.id));
                if (openNowOnly) placeList = placeList.filter(p => p.currentOpeningHours?.openNow === true);

                if (placeList.length === 0 && currentTierIdx < (tiers.length - 1)) {
                    return startSearch(type, currentTierIdx + 1);
                }
                
                stopFlicker();
                if (placeList.length > 0) {
                    const place = placeList[Math.floor(Math.random() * placeList.length)];
                    addToHistory(place, searchType);
                    showVerdict(place, searchType);
                } else {
                    showError(errorJokes[Math.floor(Math.random() * errorJokes.length)]);
                }
            } catch (e) { stopFlicker(); showError("Network error. The internet is as hungry as you are."); }
        }

        function showError(msg) {
            transition(() => {
                screen.innerHTML = `
                    <div><span id="flicker-target" class="smiley-flicker">üíÄ</span></div>
                    <h1>EMPTY PLATE</h1>
                    <div class="joke-container">${msg}</div>
                    <button onclick="showCuisineSelection()">Try Again</button>
                    <button class="back-link" onclick="location.reload()">Change Location</button>
                `;
                startFlicker(errorEmojis);
            });
        }

        function addToHistory(place, type) {
            if (history.find(h => h.id === place.id)) return;
            history.unshift({ ...place, category: type });
            if (history.length > 5) history.pop();
            document.getElementById('history-btn').style.display = 'flex';
            document.getElementById('history-count').innerText = history.length;
            updateHistoryUI();
        }

        function updateHistoryUI() {
            document.getElementById('history-list').innerHTML = history.map(h => `
                <div class="history-item">
                    <div><h4 style="margin:0;">${h.displayName.text}</h4><small>${h.category}</small></div>
                    <a href="${h.googleMapsUri}" target="_blank" style="text-decoration:none; font-size:1.4rem;">üìç</a>
                </div>
            `).join('');
        }

        function toggleHistory() { document.getElementById('history-panel').classList.toggle('open'); }

        function showVerdict(place, type) {
            transition(() => {
                screen.innerHTML = `
                    <h1>THE FIX</h1>
                    <div class="spot-card">
                        <div class="best-badge">${type}</div>
                        <h2>${place.displayName.text}</h2>
                        <p>Rating: ‚≠ê ${place.rating || 'New'}</p>
                        <a href="${place.googleMapsUri}" target="_blank" class="action-btn">LET'S GO</a>
                    </div>
                    <button class="back-link" onclick="blacklist.add('${place.id}'); startSearch('${type}')">Keep Looking</button>
                    <button class="back-link" style="text-decoration:none;" onclick="showCuisineSelection()">‚Üê Change Craving</button>
                `;
            });
        }

        function transition(cb) { container.classList.add('fade-out'); setTimeout(() => { cb(); container.classList.remove('fade-out'); container.classList.add('fade-in'); }, 400); }
        
        function debounceSearch() { 
            clearTimeout(this.timeout); 
            this.timeout = setTimeout(async () => { 
                const val = document.getElementById('cityInput').value; 
                if(val.length < 3) return;
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(val)}`); 
                const data = await res.json(); 
                const list = document.getElementById('suggestions'); 
                list.innerHTML = ""; 
                if (data.length > 0) {
                    list.style.display = 'block'; 
                    data.forEach(item => { 
                        const div = document.createElement('div'); 
                        div.className = 'suggestion-item'; 
                        const a = item.address;
                        const street = (a.house_number ? a.house_number + " " : "") + (a.road || a.pedestrian || "");
                        const city = a.city || a.town || a.village || "";
                        const state = a.state || a.province || "";
                        const country = a.country || "";
                        const label = [street, city, state, country].filter(part => part.trim() !== "").join(", ");
                        div.innerText = label; 
                        div.onclick = () => { document.getElementById('cityInput').value = label; lat = parseFloat(item.lat); lon = parseFloat(item.lon); list.style.display = 'none'; }; 
                        list.appendChild(div); 
                    });
                }
            }, 500); 
        }

        function locateMe() { 
            navigator.geolocation.getCurrentPosition(async (pos) => { 
                lat = pos.coords.latitude; lon = pos.coords.longitude; 
                document.getElementById('cityInput').value = "Your Current Location"; 
            }); 
        }
    </script>
</body>
</html>
